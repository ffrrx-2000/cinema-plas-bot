<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>صفحة مسلسل</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body, html {
    height: 100%;
    font-family: "Segoe UI", Tahoma, sans-serif;
    color: #fff;
    background: #000;
    overflow-x: hidden;
  }

  .movie-page {
    position: relative;
    width: 100%;
    height: 600px;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: top center;
  }
  .movie-page::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 400px;
    background: linear-gradient(to top, rgba(0,0,0,0.98) 50%, rgba(0,0,0,0) 90%);
    pointer-events: none;
  }
  .content {
    position: absolute;
    top: 60%;
    left: 20px;
    right: 20px;
    transform: translateY(-0%);
    z-index: 1;
  }
  .meta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 15px;
  }
  .imdb {
    display: flex;
    align-items: center;
    background: #f5c518;
    color: #000;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .imdb img { height: 16px; margin-left: 5px; }
  .sub-meta {
    display: flex;
    gap: 15px;
    justify-content: center;
  }
  .controls {
    display: flex;
    justify-content: space-around;
    align-items: center;
    max-width: 400px;
    margin: 0 auto 20px;
  }
  .controls .icon-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 1.2rem;
    cursor: pointer;
    opacity: 0.8;
  }
  .controls .icon-btn span {
    font-size: 0.75rem;
    margin-top: 4px;
  }
  .controls .play-btn {
    background: #e50914;
    color: #fff;
    padding: 8px 18px;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    opacity: 1;
  }
  .description-wrapper {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 30px;
  }
  .rating-box {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    border: 1px solid #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }
  .description {
    flex: 1;
    opacity: 0.9;
  }
  .cast-section {
    margin-bottom: 20px;
  }
  .cast-section h3 {
    font-size: 1rem;
    margin-bottom: 8px;
    text-align: right;
  }
  .cast-list {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding-bottom: 5px;
  }
  .cast-item {
    flex: 0 0 auto;
    width: 80px;
    text-align: center;
    font-size: 0.75rem;
  }
  .cast-item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
  }
  .cast-item .name {
    margin-top: 4px;
    color: #eee;
  }

  .video-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1000;
    display: none;
    justify-content: center;
    align-items: center;
  }
  .video-modal.active {
    display: flex;
  }
  .video-container {
    width: auto;
    max-width: 90%;
    max-height: 70vh;
    background-color: #1a1c24;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }
  .video-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: #1a1c24;
    border-bottom: 1px solid #2c2f3a;
  }
  .video-title {
    font-weight: bold;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .close-btn {
    background: none;
    border: none;
    color: #fff;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    margin-right: -5px;
  }
  .video-player-wrapper {
    position: relative;
    width: 100%;
    background-color: #000;
  }
  #videoPlayer {
    display: block;
    width: 100%;
    max-height: 60vh;
  }
  .video-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
    padding: 8px;
    display: flex;
    flex-direction: column;
    direction: ltr;
    transition: opacity 0.3s ease;
    opacity: 1;
    pointer-events: auto;
    z-index: 100;
  }
  .progress-container {
    width: 100%;
    height: 3px;
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 1.5px;
    margin-bottom: 8px;
    cursor: pointer;
  }
  .progress-bar {
    height: 100%;
    background-color: #e50914;
    border-radius: 1.5px;
    width: 0%;
  }
  .control-buttons {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .left-controls, .right-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .control-btn {
    background: none;
    border: none;
    color: #fff;
    cursor: pointer;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }
  .play-pause-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: 1px solid #e50914;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .time-display {
    font-size: 11px;
    color: #fff;
  }
  .fullscreen-btn {
    margin-left: 8px;
  }
  .video-player-wrapper.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw !important;
    height: 100vh !important;
    background: #000;
    z-index: 2000;
  }
  .video-player-wrapper.fullscreen #videoPlayer {
    width: 100% !important;
    height: 100% !important;
    max-height: none !important;
    object-fit: contain !important;
  }

  .trailers-section {
    margin-top: 40px;
    margin-bottom: 40px;
  }
  .trailers-section h3 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    text-align: right;
    color: #fff;
  }
  .trailers-row {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 5px;
    scroll-behavior: smooth;
    scrollbar-width: none;
  }
  .trailers-row::-webkit-scrollbar {
    display: none;
  }
  .trailer-item {
    flex: 0 0 auto;
    width: 240px;
    position: relative;
    display: block;
    aspect-ratio: 16/9;
    background-color: #000;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s;
  }
  .trailer-item:hover {
    transform: scale(1.05);
  }
  .trailer-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .trailer-item i.fa-play {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 36px;
    color: white;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  }

  .seasons-section {
    margin-top: 40px;
    margin-bottom: 40px;
  }
  .seasons-section h3 {
    font-size: 1.3rem;
    margin-bottom: 20px;
    text-align: right;
    color: #fff;
    font-weight: bold;
  }
  .seasons-row {
    display: flex;
    gap: 15px;
    overflow-x: auto;
    padding: 10px 0;
    scroll-behavior: smooth;
    scrollbar-width: none;
  }
  .seasons-row::-webkit-scrollbar {
    display: none;
  }
  .season-item {
    flex: 0 0 auto;
    width: 160px;
    cursor: pointer;
    transition: transform 0.3s ease;
  }
  .season-item:hover {
    transform: scale(1.05);
  }
  .season-poster {
    width: 100%;
    height: 220px;
    object-fit: cover;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  }
  .season-info {
    margin-top: 10px;
    text-align: center;
  }
  .season-title {
    color: #fff;
    font-size: 1rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  .season-episodes {
    color: #888;
    font-size: 0.85rem;
  }

  .episodes-section {
    margin-top: 40px;
    margin-bottom: 40px;
  }
  .episodes-section h3 {
    font-size: 1.3rem;
    margin-bottom: 20px;
    text-align: right;
    color: #fff;
    font-weight: bold;
  }
  .episodes-list {
    display: none;
  }
  .episodes-list.active {
    display: block;
  }
  .episode-item {
    display: flex;
    align-items: flex-start;
    background: transparent;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #333;
    position: relative;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  .episode-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
  }
  .episode-content {
    flex: 1;
    padding-left: 15px;
    text-align: right;
  }
  .episode-title {
    color: #fff;
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 10px;
    line-height: 1.3;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .episode-duration {
    color: #888;
    font-size: 0.9rem;
    margin-bottom: 10px;
  }
  .episode-description {
    color: #ccc;
    font-size: 0.95rem;
    line-height: 1.4;
    margin-bottom: 15px;
  }
  .episode-description.collapsed {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .show-more {
    color: #1e90ff;
    cursor: pointer;
    font-weight: bold;
    margin-top: 5px;
    display: inline-block;
  }
  .episode-thumbnail {
    width: 120px;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    flex-shrink: 0;
  }

  .recommend-section {
    margin-top: 40px;
  }
  .recommend-section h3 {
    font-size: 1.2em;
    margin-bottom: 10px;
    text-align: right;
  }
  .recommend-row {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 10px;
    scroll-behavior: smooth;
  }
  .recommend-card {
    flex: 0 0 auto;
    width: 140px;
    background-color: #111;
    border-radius: 8px;
    overflow: hidden;
    text-align: center;
    color: #fff;
    transition: transform 0.2s;
  }
  .recommend-card:hover {
    transform: scale(1.05);
  }
  .recommend-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .video-player-wrapper.fullscreen .video-controls {
    opacity: 1;
    pointer-events: auto;
  }
  .video-controls.hidden {
    opacity: 0 !important;
    pointer-events: none !important;
  }
  .controls .icon-btn.active {
    color: #e50914;
    opacity: 1;
  }
  .skip-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
  }
  .quality-btn {
    position: relative;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 1px solid rgba(255,255,255,0.3);
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 14px;
  }
  .quality-menu {
    position: absolute;
    bottom: 40px;
    right: 0;
    background: rgba(0, 0, 0, 0.95);
    border-radius: 8px;
    padding: 8px 0;
    min-width: 120px;
    display: none;
    flex-direction: column;
    z-index: 1000;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  .quality-menu.active {
    display: flex;
  }
  .quality-option {
    padding: 10px 16px;
    cursor: pointer;
    color: #fff;
    font-size: 13px;
    transition: background-color 0.2s;
    text-align: right;
  }
  .quality-option:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }
  .quality-option.selected {
    color: #e50914;
    font-weight: bold;
  }
  .tmdb-logo {
    margin-bottom: 5px;
    text-align: center;
  }
  .tmdb-logo img {
    height: 70px;
    object-fit: contain;
  }
  * {
    -webkit-tap-highlight-color: transparent;
  }
  a, button, div, span {
    outline: none;
  }
</style>
</head>
<body>

<div class="movie-page" id="moviePage">
<div class="content">
  <div class="meta">
    <div class="tmdb-logo" id="seriesLogo"></div>
    <div class="imdb">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/69/IMDB_Logo_2016.svg" alt="IMDb">
      <span id="imdbRating">0.0</span>
    </div>
    <div class="sub-meta">
      <div id="yearGenre"></div>
      <div id="seasons"></div>
    </div>
  </div>

  <div class="controls">
    <div class="icon-btn" title="أعجبني" id="likeBtn"><i class="fa-regular fa-heart"></i><span>أعجبني</span></div>
    <div class="icon-btn" title="مشاهدة لاحقاً" id="watchLaterBtn"><i class="fa-regular fa-bookmark"></i><span>لاحقاً</span></div>
    <div class="play-btn" title="شاهد الآن" id="watchNowBtn"><i class="fa-solid fa-play"></i><span>S1 E1</span></div>
    <div class="icon-btn" title="تحميل"><i class="fa-solid fa-download"></i><span>تحميل</span></div>
    <div class="icon-btn" title="مشاهدة الإعلان"><i class="fa-brands fa-youtube"></i><span>إعلان</span></div>
  </div>

  <div class="description-wrapper">
    <div class="rating-box">R</div>
    <div class="description" id="overview">جاري جلب التفاصيل...</div>
  </div>

  <div class="cast-section">
    <h3>الممثلون</h3>
    <div class="cast-list" id="castList"></div>
  </div>
  
  <div class="trailers-section">
    <h3>الإعلانات</h3>
    <div id="trailersList" class="trailers-row"></div>
  </div>

  <div class="seasons-section">
    <h3>المواسم</h3>
    <div id="seasonsList" class="seasons-row"></div>
  </div>

  <div class="episodes-section">
    <h3>الحلقات</h3>
    <div id="episodesList"></div>
  </div>
  
  <div class="recommend-section">
    <h3>مقترحات</h3>
    <div id="recommendations" class="recommend-row"></div>
  </div>
</div>
</div>

<div class="video-modal" id="videoModal">
<div class="video-container">
  <div class="video-header">
    <div class="video-title" id="videoTitle"></div>
    <button class="close-btn" id="closeVideoBtn">x</button>
  </div>
  <div class="video-player-wrapper" id="videoPlayerWrapper">
    <video id="videoPlayer" playsinline>
      <source src="#" type="video/mp4">
    </video>
    <div class="video-controls" id="videoControls">
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="control-buttons">
        <div class="left-controls">
          <button class="control-btn skip-btn" id="backwardBtn"><i class="fa-solid fa-backward-step"></i></button>
          <button class="control-btn play-pause-btn" id="playPauseBtn"><i class="fa-solid fa-pause" id="playPauseIcon"></i></button>
          <button class="control-btn skip-btn" id="forwardBtn"><i class="fa-solid fa-forward-step"></i></button>
          <div class="time-display"><span id="currentTime">00:00</span> / <span id="totalTime">00:00</span></div>
        </div>
        <div class="right-controls">
          <button class="control-btn" id="aspectBtn"><i class="fa-solid fa-tv"></i></button>
          <div style="position: relative;">
            <button class="control-btn quality-btn" id="qualityBtn"><i class="fa-solid fa-gear"></i></button>
            <div class="quality-menu" id="qualityMenu"></div>
          </div>
          <button class="control-btn fullscreen-btn" id="fullscreenBtn"><i class="fa-solid fa-expand"></i></button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<script>
const API_KEY = "06f120992cfacd7c118f6e7086d23544";
const SERIES_ID = 106379;

const episodeLinks = {
    "1-1": "46lLvi5wmmVRBn3ad6j02XruD02e00O9pBd45F01Cr600niM",
    "1-2": "yMQ7SIaiq5lBkEzshmZHFZ00WzZB1gQGFtJPH4023bjbY",
    "1-3": "2005MkOA8OixsEs01W6mCpAk11yVPE3AlkmSV6LUY25FM",
    "1-4": "JphYQfJVNBE6UM00Z3dS900N02fKDa02PNotX026qby7cm5E",
    "1-5": "OMyZ3r01ohHoTlgdFfPf8dGD02ED6wUhM2a3Vh7ft7Z01c",
    "1-6": "q28wwLtb6ImyU175GpeE02BQWCHeiV02tdH25Vz01bUq9g",
    "1-7": "R9uj9PNePyPB3ENCVP3tt8NXgF0265ctPJyswfVwu8CU",
    "1-8": "N2na21qumoOrVqv75GJgKlZCsAznWJAP8beyiWkMiTo",
    "2-1": "fDbhWeBwcFa8uyh7iKL601Fz01bbflm6La02IcROlobtGQ",
    "2-2": "WpCeFsT3jbsJI4gVxarR9nyX51FSX00durYoVtZdvKUk",
    "2-3": "02dOB5SAUfYCb3cwMWE7ZiaWvVuUy6AJjQsN02W6fQe18",
    "2-4": "jUldT3rgEBfH5jTSdWuF900BYnWObJ64a02cZfU00wp01XM",
    "2-5": "7G17S00c1YAy800EsfzY01IyPi7DwuE2zfu01uab6UupBfo"
};

// ===== قواعد عرض العناوين =====
const WESTERN_LANGUAGES = ['en', 'fr', 'de', 'it', 'es', 'pt', 'nl', 'sv', 'no', 'da', 'fi', 'pl', 'cs', 'hu', 'ro', 'el', 'ru', 'uk'];
const ASIAN_LANGUAGES = ['ja', 'ko', 'zh', 'th', 'vi', 'id', 'ms', 'tl', 'hi', 'ta', 'te', 'ml', 'bn'];
const TURKISH_LANGUAGES = ['tr'];
const WESTERN_COUNTRIES = ['US', 'GB', 'CA', 'AU', 'NZ', 'IE', 'FR', 'DE', 'IT', 'ES', 'PT', 'NL', 'BE', 'AT', 'CH', 'SE', 'NO', 'DK', 'FI', 'PL', 'CZ', 'HU', 'RO', 'GR', 'RU', 'UA', 'MX', 'BR', 'AR', 'CO', 'CL', 'PE'];
const ASIAN_COUNTRIES = ['JP', 'KR', 'CN', 'TW', 'HK', 'TH', 'VN', 'ID', 'MY', 'PH', 'SG', 'IN'];
const TURKISH_COUNTRIES = ['TR'];

function determineTitleDisplay(data, arabicData) {
  const originalLang = data.original_language || '';
  const originCountry = data.origin_country || [];
  const originalTitle = data.original_name || '';
  const englishTitle = data.name || '';
  const arabicTitle = arabicData ? arabicData.name : null;
  
  let primary = '';
  let secondary = null;
  
  // تركي
  if (TURKISH_LANGUAGES.includes(originalLang) || originCountry.some(c => TURKISH_COUNTRIES.includes(c))) {
    primary = originalTitle;
    if (englishTitle && englishTitle !== originalTitle) {
      secondary = englishTitle;
    }
  }
  // آسيوي
  else if (ASIAN_LANGUAGES.includes(originalLang) || originCountry.some(c => ASIAN_COUNTRIES.includes(c))) {
    primary = englishTitle;
    secondary = null;
  }
  // غربي
  else {
    primary = englishTitle;
    if (arabicTitle && arabicTitle !== englishTitle) {
      secondary = arabicTitle;
    }
  }
  
  return { primary, secondary };
}

let currentSeason = 1;
  let isFullscreen = false;
  let controlsVisible = true;
  let controlsTimeout;
  let hls = null;
  let currentQualityLevels = [];
  let seriesPosterUrl = ''; // متغير لحفظ صورة البوستر
  let currentAspectMode = 0; // لتتبع وضع العرض الحالي
  const aspectModes = ['contain', 'cover', 'fill']; // أوضاع العرض المختلفة

const videoModal = document.getElementById("videoModal");
const watchNowBtn = document.getElementById("watchNowBtn");
const closeVideoBtn = document.getElementById("closeVideoBtn");
const videoPlayer = document.getElementById("videoPlayer");
const playPauseBtn = document.getElementById("playPauseBtn");
const playPauseIcon = document.getElementById("playPauseIcon");
const currentTimeDisplay = document.getElementById("currentTime");
const totalTimeDisplay = document.getElementById("totalTime");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const fullscreenBtn = document.getElementById("fullscreenBtn");
const aspectBtn = document.getElementById("aspectBtn");
const videoPlayerWrapper = document.getElementById("videoPlayerWrapper");
const videoControls = document.getElementById("videoControls");
const backwardBtn = document.getElementById("backwardBtn");
const forwardBtn = document.getElementById("forwardBtn");
const qualityBtn = document.getElementById("qualityBtn");
const qualityMenu = document.getElementById("qualityMenu");
const likeBtn = document.getElementById("likeBtn");
const watchLaterBtn = document.getElementById("watchLaterBtn");

backwardBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
  resetControlsTimer();
});

forwardBtn.addEventListener("click", (e) => {
  e.stopPropagation();
  videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10);
  resetControlsTimer();
});

// جلب بيانات المسلسل
Promise.all([
  fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}?api_key=${API_KEY}&language=en`).then(r => r.json()),
  fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}?api_key=${API_KEY}&language=ar`).then(r => r.json())
]).then(([enData, arData]) => {
  const titles = determineTitleDisplay(enData, arData);
  
  // جلب صورة البوستر للخلفية
  fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/images?api_key=${API_KEY}`)
  .then(res => res.json())
  .then(images => {
  const cleanPoster = images.posters.find(p => p.iso_639_1 === null);
  const imagePath = cleanPoster ? cleanPoster.file_path : enData.poster_path;
  if (imagePath) {
  document.getElementById("moviePage").style.backgroundImage = `url(https://image.tmdb.org/t/p/original${imagePath})`;
  }
  });

  // حفظ صورة الخلفية الأفقية (backdrop) لاستخدامها في المشغل
  const backdropPath = enData.backdrop_path;
  if (backdropPath) {
    seriesPosterUrl = `https://image.tmdb.org/t/p/w1280${backdropPath}`;
  } else if (enData.poster_path) {
    seriesPosterUrl = `https://image.tmdb.org/t/p/w780${enData.poster_path}`;
  }
  
  document.getElementById("imdbRating").textContent = enData.vote_average.toFixed(1);
  
  // ترجمة التصنيفات إلى العربية
  const genreTranslations = {
    "Action": "اكشن",
    "Adventure": "مغامرة",
    "Animation": "رسوم متحركة",
    "Comedy": "كوميديا",
    "Crime": "جريمة",
    "Documentary": "وثائقي",
    "Drama": "دراما",
    "Family": "عائلي",
    "Fantasy": "فانتازيا",
    "History": "تاريخي",
    "Horror": "رعب",
    "Music": "موسيقي",
    "Mystery": "غموض",
    "Romance": "رومانسي",
    "Science Fiction": "خيال علمي",
    "Sci-Fi & Fantasy": "خيال علمي وفانتازيا",
    "TV Movie": "فيلم تلفزيوني",
    "Thriller": "اثارة",
    "War": "حرب",
    "Western": "غربي",
    "Action & Adventure": "اكشن ومغامرة",
    "Kids": "اطفال",
    "News": "اخبار",
    "Reality": "واقعي",
    "Soap": "مسلسل درامي",
    "Talk": "حواري",
    "War & Politics": "حرب وسياسة"
  };
  const genres = enData.genres.map(g => genreTranslations[g.name] || g.name).join(" . ");
  document.getElementById("yearGenre").textContent = `${enData.first_air_date.slice(0,4)} . ${genres}`;
  document.getElementById("seasons").textContent = `${enData.number_of_seasons} مواسم . ${enData.number_of_episodes} حلقة`;
  document.getElementById("overview").textContent = arData.overview || enData.overview;
  document.getElementById("videoTitle").textContent = titles.primary;
  
  displaySeasons(enData.seasons);
});

// جلب الممثلين
fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/credits?api_key=${API_KEY}&language=ar`)
  .then(res => res.json())
  .then(credits => {
    const castList = document.getElementById("castList");
    credits.cast.slice(0, 10).forEach(member => {
      const div = document.createElement("div");
      div.className = "cast-item";
      div.innerHTML = `
        <img src="${member.profile_path ? `https://image.tmdb.org/t/p/w185${member.profile_path}` : 'https://g.top4top.io/p_34489upmc7.jpg'}" alt="${member.name}">
        <div class="name">${member.name}</div>
      `;
      castList.appendChild(div);
    });
  });

function displaySeasons(seasons) {
  const seasonsList = document.getElementById("seasonsList");
  seasons.forEach(season => {
    if (season.season_number === 0) return;
    if (!season.air_date) return;
    const seasonAirDate = new Date(season.air_date);
    const currentDate = new Date();
    if (seasonAirDate > currentDate) return;
    if (!season.episode_count || season.episode_count === 0) return;
    
    const seasonItem = document.createElement("div");
    seasonItem.className = "season-item";
    seasonItem.onclick = () => showEpisodes(season.season_number);
    seasonItem.innerHTML = `
      <img src="${season.poster_path ? `https://image.tmdb.org/t/p/w500${season.poster_path}` : 'https://g.top4top.io/p_34489upmc7.jpg'}" alt="الموسم ${season.season_number}" class="season-poster">
      <div class="season-info">
        <div class="season-title">الموسم ${season.season_number}</div>
        <div class="season-episodes">${season.episode_count} حلقة</div>
      </div>
    `;
    seasonsList.appendChild(seasonItem);
  });
}

function showEpisodes(seasonNumber) {
  currentSeason = seasonNumber;
  const episodesList = document.getElementById("episodesList");
  const allEpisodeLists = episodesList.querySelectorAll('.episodes-list');
  allEpisodeLists.forEach(list => list.classList.remove('active'));
  
  let currentEpisodesList = document.getElementById(`episodes-season-${seasonNumber}`);
  
  if (!currentEpisodesList) {
    currentEpisodesList = document.createElement('div');
    currentEpisodesList.id = `episodes-season-${seasonNumber}`;
    currentEpisodesList.className = 'episodes-list';
    
    fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/season/${seasonNumber}?api_key=${API_KEY}&language=ar`)
      .then(res => res.json())
      .then(data => {
        data.episodes.forEach(episode => {
          const episodeElement = createEpisodeElement(episode, seasonNumber);
          currentEpisodesList.appendChild(episodeElement);
        });
      });
    
    episodesList.appendChild(currentEpisodesList);
  }
  
  currentEpisodesList.classList.add('active');
}

function createEpisodeElement(episode, seasonNumber) {
  const episodeItem = document.createElement('div');
  episodeItem.className = 'episode-item';
  
  const stillPath = episode.still_path ? `https://image.tmdb.org/t/p/w300${episode.still_path}` : 'https://g.top4top.io/p_34489upmc7.jpg';
  const runtime = episode.runtime || 45;
  const episodeKey = `${seasonNumber}-${episode.episode_number}`;
  const videoUrl = episodeLinks[episodeKey] || '#';
  const durationText = `${Math.floor(runtime)} د`;
  const description = episode.overview || '';
  const shortDescription = description.length > 100 ? description.substring(0, 100) + '...' : description;
  
  episodeItem.innerHTML = `
    <div class="episode-content">
      <div class="episode-title">${episode.name || `الحلقة ${episode.episode_number}`} | E${episode.episode_number}</div>
      <div class="episode-duration">${durationText}</div>
      <div class="episode-description collapsed" data-full="${description}">
        ${shortDescription}
        ${description.length > 100 ? '<span class="show-more">اظهر المزيد</span>' : ''}
      </div>
    </div>
    <img src="${stillPath}" alt="الحلقة ${episode.episode_number}" class="episode-thumbnail">
  `;
  
  episodeItem.addEventListener('click', (e) => {
    if (!e.target.classList.contains('show-more')) {
      playEpisode(videoUrl, `الموسم ${seasonNumber} - الحلقة ${episode.episode_number}`);
    }
  });
  
  return episodeItem;
}

function playEpisode(videoUrl, title) {
  if (videoUrl === '#') {
    alert('سيتم توفر الحلقة قريبا');
    return;
  }
  
  document.getElementById("videoModal").classList.add("active");
  document.getElementById("videoTitle").textContent = title;
  
  // تعيين صورة البوستر كخلفية قبل التشغيل
  if (seriesPosterUrl) {
    videoPlayer.poster = seriesPosterUrl;
  }
  
  if (hls) {
    hls.destroy();
    hls = null;
  }
  
  if (!videoUrl.startsWith("http")) {
    videoUrl = `https://stream.mux.com/${videoUrl}.m3u8`;
  }
  
  const isHLS = videoUrl.endsWith('.m3u8');
  
  if (isHLS && Hls.isSupported()) {
    hls = new Hls({ enableWorker: true, lowLatencyMode: true });
    hls.loadSource(videoUrl);
    hls.attachMedia(videoPlayer);
    hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
      currentQualityLevels = data.levels;
      buildQualityMenu();
      qualityBtn.style.display = 'flex';
      videoPlayer.play();
    });
  } else if (isHLS && videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
    videoPlayer.src = videoUrl;
    videoPlayer.load();
    videoPlayer.play();
    qualityBtn.style.display = 'none';
  } else {
    videoPlayer.src = videoUrl;
    videoPlayer.load();
    videoPlayer.play();
    qualityBtn.style.display = 'none';
  }
  
  showControls();
  resetControlsTimer();
}

function buildQualityMenu() {
  qualityMenu.innerHTML = '';
  const autoOption = document.createElement('div');
  autoOption.className = 'quality-option selected';
  autoOption.textContent = 'تلقائي (Auto)';
  autoOption.onclick = function() {
    if (hls) {
      hls.currentLevel = -1;
      updateQualitySelection(-1);
      qualityMenu.classList.remove('active');
    }
  };
  qualityMenu.appendChild(autoOption);
  
  currentQualityLevels.forEach((level, index) => {
    const option = document.createElement('div');
    option.className = 'quality-option';
    const height = level.height;
    let qualityName = height + 'p';
    if (height >= 2160) qualityName = '4K';
    else if (height >= 1440) qualityName = '2K';
    else if (height >= 1080) qualityName = '1080p';
    else if (height >= 720) qualityName = '720p';
    option.textContent = qualityName;
    option.onclick = function() {
      if (hls) {
        hls.currentLevel = index;
        updateQualitySelection(index);
        qualityMenu.classList.remove('active');
      }
    };
    qualityMenu.appendChild(option);
  });
}

function updateQualitySelection(selectedIndex) {
  const options = qualityMenu.querySelectorAll('.quality-option');
  options.forEach((option, index) => {
    option.classList.remove('selected');
    if (index === selectedIndex + 1) option.classList.add('selected');
    else if (selectedIndex === -1 && index === 0) option.classList.add('selected');
  });
}

qualityBtn.addEventListener('click', function(e) {
  e.stopPropagation();
  qualityMenu.classList.toggle('active');
  resetControlsTimer();
});

// الإعلانات
fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/videos?api_key=${API_KEY}`)
  .then(res => res.json())
  .then(data => {
    const trailersList = document.getElementById("trailersList");
    const youtubeTrailers = data.results.filter(v => v.site === "YouTube" && (v.type === "Trailer" || v.type === "Teaser")).slice(0, 3);
    if (youtubeTrailers.length === 0) {
      document.querySelector('.trailers-section').style.display = 'none';
      return;
    }
    youtubeTrailers.forEach(trailer => {
      const el = document.createElement("a");
      el.href = `https://www.youtube.com/watch?v=${trailer.key}`;
      el.target = "_blank";
      el.className = "trailer-item";
      el.innerHTML = `<img src="https://img.youtube.com/vi/${trailer.key}/maxresdefault.jpg" alt="${trailer.name}" onerror="this.src='https://img.youtube.com/vi/${trailer.key}/hqdefault.jpg'"/><i class="fa-solid fa-play"></i>`;
      trailersList.appendChild(el);
    });
  });

setTimeout(() => showEpisodes(1), 1000);

watchNowBtn.addEventListener("click", () => {
  if (episodeLinks["1-1"]) {
    playEpisode(episodeLinks["1-1"], "الموسم 1 - الحلقة 1");
  } else {
    alert('لا توجد حلقات متاحة للتشغيل');
  }
});

closeVideoBtn.addEventListener("click", () => {
  videoModal.classList.remove("active");
  videoPlayer.pause();
  if (hls) { hls.destroy(); hls = null; }
});

videoModal.addEventListener("click", (e) => {
  if (e.target === videoModal) {
    videoModal.classList.remove("active");
    videoPlayer.pause();
    if (hls) { hls.destroy(); hls = null; }
  }
});

function togglePlay(e) {
  if (e) e.stopPropagation();
  if (videoPlayer.paused) {
    videoPlayer.play();
    playPauseIcon.classList.remove("fa-play");
    playPauseIcon.classList.add("fa-pause");
  } else {
    videoPlayer.pause();
    playPauseIcon.classList.remove("fa-pause");
    playPauseIcon.classList.add("fa-play");
  }
  resetControlsTimer();
}

playPauseBtn.addEventListener("click", togglePlay);

videoPlayer.addEventListener("timeupdate", () => {
  const currentTime = videoPlayer.currentTime;
  const duration = videoPlayer.duration;
  if (isNaN(duration)) return;
  progressBar.style.width = `${(currentTime / duration) * 100}%`;
  currentTimeDisplay.textContent = formatTime(currentTime);
  totalTimeDisplay.textContent = formatTime(duration);
});

progressContainer.addEventListener("click", (e) => {
  e.stopPropagation();
  const width = progressContainer.offsetWidth;
  const clickX = e.offsetX;
  videoPlayer.currentTime = (clickX / width) * videoPlayer.duration;
  resetControlsTimer();
});

function formatTime(time) {
  const m = Math.floor(time / 60);
  const s = Math.floor(time % 60);
  return `${m < 10 ? '0' + m : m}:${s < 10 ? '0' + s : s}`;
}

fullscreenBtn.addEventListener("click", function(e) {
  e.stopPropagation();
  toggleFullscreen();
});

function toggleFullscreen() {
  if (!isFullscreen) {
    if (videoPlayerWrapper.requestFullscreen) {
      videoPlayerWrapper.requestFullscreen();
    } else if (videoPlayerWrapper.mozRequestFullScreen) {
      videoPlayerWrapper.mozRequestFullScreen();
    } else if (videoPlayerWrapper.webkitRequestFullscreen) {
      videoPlayerWrapper.webkitRequestFullscreen();
    } else if (videoPlayerWrapper.msRequestFullscreen) {
      videoPlayerWrapper.msRequestFullscreen();
    }
    
    videoPlayerWrapper.classList.add("fullscreen");
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-compress"></i>';
    isFullscreen = true;
    
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    
    videoPlayerWrapper.classList.remove("fullscreen");
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
    isFullscreen = false;
  }
  
  resetControlsTimer();
}

aspectBtn.addEventListener("click", function(e) {
  e.stopPropagation();
  if (videoPlayer.style.objectFit === "cover") {
    videoPlayer.style.objectFit = "contain";
    aspectBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
  } else {
    videoPlayer.style.objectFit = "cover";
    aspectBtn.innerHTML = '<i class="fa-solid fa-tv"></i>';
  }
  resetControlsTimer();
});

document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('MSFullscreenChange', handleFullscreenChange);

function handleFullscreenChange() {
  if (!document.fullscreenElement && 
      !document.webkitFullscreenElement && 
      !document.mozFullScreenElement && 
      !document.msFullscreenElement) {
    
    videoPlayerWrapper.classList.remove("fullscreen");
    fullscreenBtn.innerHTML = '<i class="fa-solid fa-expand"></i>';
    isFullscreen = false;
    showControls();
  }
}

function showControls() {
  videoControls.classList.remove('hidden');
  controlsVisible = true;
  resetControlsTimer();
}

function hideControls() {
  if (!videoPlayer.paused) {
    videoControls.classList.add('hidden');
    controlsVisible = false;
  }
}

function resetControlsTimer() {
  clearTimeout(controlsTimeout);
  controlsTimeout = setTimeout(() => {
    if (!videoPlayer.paused) {
      hideControls();
    }
  }, 5000);
}

videoPlayerWrapper.addEventListener('click', function(e) {
  if (e.target.closest('.video-controls')) {
    return;
  }
  
  if (controlsVisible) {
    hideControls();
  } else {
    showControls();
  }
});

videoPlayerWrapper.addEventListener('mousemove', function() {
  showControls();
});

videoPlayerWrapper.addEventListener('touchstart', function(e) {
  if (e.target.closest('.video-controls')) {
    return;
  }
  
  if (controlsVisible) {
    hideControls();
  } else {
    showControls();
  }
});

videoControls.addEventListener('mousemove', function(e) {
  e.stopPropagation();
  resetControlsTimer();
});

videoControls.addEventListener('click', function(e) {
  e.stopPropagation();
  resetControlsTimer();
});

videoPlayer.addEventListener('play', function() {
  resetControlsTimer();
});

// جلب شعار المسلسل
fetch(`https://api.themoviedb.org/3/tv/${SERIES_ID}/images?api_key=${API_KEY}`)
  .then(res => res.json())
  .then(images => {
    const logo = images.logos.find(l => l.iso_639_1 === "en") || images.logos[0];
    const logoContainer = document.getElementById("seriesLogo");
    if (logo && logo.file_path) {
      logoContainer.innerHTML = `<img src="https://image.tmdb.org/t/p/original${logo.file_path}" alt="Series Logo">`;
    } else {
      logoContainer.style.display = "none";
    }
  });

// LocalStorage للإعجاب والمشاهدة لاحقًا
function saveToLocalStorage(key, value) {
  try { localStorage.setItem(key, JSON.stringify(value)); } catch(e) {}
}
function loadFromLocalStorage(key) {
  try { return JSON.parse(localStorage.getItem(key)) || null; } catch(e) { return null; }
}

likeBtn.addEventListener('click', () => {
  const saved = loadFromLocalStorage('likedSeries') || [];
  const icon = likeBtn.querySelector('i');
  if (likeBtn.classList.contains('active')) {
    likeBtn.classList.remove('active');
    icon.classList.replace('fa-solid', 'fa-regular');
    const idx = saved.indexOf(SERIES_ID);
    if (idx > -1) saved.splice(idx, 1);
  } else {
    likeBtn.classList.add('active');
    icon.classList.replace('fa-regular', 'fa-solid');
    if (!saved.includes(SERIES_ID)) saved.push(SERIES_ID);
  }
  saveToLocalStorage('likedSeries', saved);
});

watchLaterBtn.addEventListener('click', () => {
  const saved = loadFromLocalStorage('watchLaterSeries') || [];
  const icon = watchLaterBtn.querySelector('i');
  if (watchLaterBtn.classList.contains('active')) {
    watchLaterBtn.classList.remove('active');
    icon.classList.replace('fa-solid', 'fa-regular');
    const idx = saved.indexOf(SERIES_ID);
    if (idx > -1) saved.splice(idx, 1);
  } else {
    watchLaterBtn.classList.add('active');
    icon.classList.replace('fa-regular', 'fa-solid');
    if (!saved.includes(SERIES_ID)) saved.push(SERIES_ID);
  }
  saveToLocalStorage('watchLaterSeries', saved);
});

document.addEventListener('DOMContentLoaded', () => {
  const savedLikes = loadFromLocalStorage('likedSeries') || [];
  const savedWatchLater = loadFromLocalStorage('watchLaterSeries') || [];
  if (savedLikes.includes(SERIES_ID)) {
    likeBtn.classList.add('active');
    likeBtn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
  }
  if (savedWatchLater.includes(SERIES_ID)) {
    watchLaterBtn.classList.add('active');
    watchLaterBtn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
  }
});

document.addEventListener('keydown', function(e) {
  if (videoModal.classList.contains('active')) {
    if (e.code === 'Space') { e.preventDefault(); togglePlay(); }
    else if (e.code === 'Escape' && isFullscreen) toggleFullscreen();
    else if (e.code === 'KeyF') toggleFullscreen();
    else if (e.code === 'ArrowRight') { videoPlayer.currentTime = Math.min(videoPlayer.duration, videoPlayer.currentTime + 10); showControls(); }
    else if (e.code === 'ArrowLeft') { videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10); showControls(); }
  }
});
</script>
</body>
</html>